stages:
  - build
  - test
  - push
  - deploy

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"
  BACKEND_IMAGE: $CI_REGISTRY_IMAGE/backend:$CI_COMMIT_SHORT_SHA
  FRONTEND_IMAGE: $CI_REGISTRY_IMAGE/frontend:$CI_COMMIT_SHORT_SHA

# Stage 1: Build - Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù€ Docker Images
build_backend:
  stage: build
  image: docker:24.0.5
  services:
    - docker:24.0.5-dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - cd backend
    - docker build -t $BACKEND_IMAGE .
    - docker push $BACKEND_IMAGE
  only:
    - main
    - develop

build_frontend:
  stage: build
  image: docker:24.0.5
  services:
    - docker:24.0.5-dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - cd frontend
    - docker build -t $FRONTEND_IMAGE .
    - docker push $FRONTEND_IMAGE
  only:
    - main
    - develop

# Stage 2: Test - Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙƒÙˆØ¯
test_backend:
  stage: test
  image: python:3.11
  variables:
    PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  cache:
    key: pip-cache
    paths:
      - .cache/pip
  script:
    - echo "PWD:" && pwd
    - ls -la
    - test -f backend/requirements.txt || (echo "âŒ backend/requirements.txt missing!" && exit 42)
    - pip install --upgrade pip
    - pip install -r backend/requirements.txt
    # Ù„Ùˆ Ø¹Ù†Ø¯Ùƒ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª pytest Ø´ØºÙ‘Ù„Ù‡Ø§ØŒ Ù„Ùˆ Ù„Ø£ Ù‡Ù†Ø¹Ø¯Ù‘ÙŠ
    - pip install pytest || true
    - pytest -q || echo "No pytest tests found, skipping"
  only:
    - main
    - develop

test_frontend:
  stage: test
  image: node:18
  script:
    - cd frontend
    - npm install
    - npm run test || echo "No tests found"
  only:
    - main
    - develop

# Stage 3: Push - Ø±ÙØ¹ Ø§Ù„Ù€ Images Ù„Ù„Ù€ Registry
push_images:
  stage: push
  image: docker:24.0.5
  services:
    - docker:24.0.5-dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    # Tag as latest
    - docker pull $BACKEND_IMAGE
    - docker tag $BACKEND_IMAGE $CI_REGISTRY_IMAGE/backend:latest
    - docker push $CI_REGISTRY_IMAGE/backend:latest
    
    - docker pull $FRONTEND_IMAGE
    - docker tag $FRONTEND_IMAGE $CI_REGISTRY_IMAGE/frontend:latest
    - docker push $CI_REGISTRY_IMAGE/frontend:latest
  only:
    - main

# ===== Stage 4: Deploy - Ù†Ø´Ø± Ø¹Ù„Ù‰ Kubernetes =====
deploy_to_k8s:
  stage: deploy
  image: bitnami/kubectl:latest
  entrypoint: [""]     # Ø¶Ø±ÙˆØ±ÙŠ Ø¬Ø¯Ù‹Ø§ Ù„Ø£Ù† Ø§Ù„ØµÙˆØ±Ø© Ø¨ØªØ´ØºÙ‘Ù„ kubectl ÙƒÙ€ entrypoint Ø§ÙØªØ±Ø§Ø¶ÙŠ
  before_script:
    # ØªØ¬Ù‡ÙŠØ² Ù…Ù„Ù kubeconfig Ù…Ù† Ø§Ù„Ù…ØªØºÙŠØ± Ø§Ù„Ù…Ø®Ø²Ù‘ÙÙ† ÙÙŠ GitLab
    - mkdir -p ~/.kube
    - echo "$KUBECONFIG_CONTENT" > ~/.kube/config
    # Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù€ cluster
    - kubectl version --client
    - kubectl config get-contexts
    - kubectl get nodes || (echo "âŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù€ cluster" && exit 1)
  script:
    # ØªØ­Ø¯ÙŠØ« ØµÙˆØ± Ø§Ù„Ù€ Deployments ÙÙŠ Kubernetes
    - echo "ğŸ”„ ØªØ­Ø¯ÙŠØ« ØµÙˆØ±Ø© backend Ø¥Ù„Ù‰: $BACKEND_IMAGE"
    - kubectl set image deployment/backend backend=$BACKEND_IMAGE -n default
    - echo "ğŸ”„ ØªØ­Ø¯ÙŠØ« ØµÙˆØ±Ø© frontend Ø¥Ù„Ù‰: $FRONTEND_IMAGE"
    - kubectl set image deployment/frontend frontend=$FRONTEND_IMAGE -n default

    # Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù€ rollout Ù„Ù„ØªØ£ÙƒØ¯ Ø¥Ù† Ø§Ù„Ù€ Pods Ø§Ø´ØªØºÙ„Øª Ø¨Ù†Ø¬Ø§Ø­
    - echo "â³ Ø§Ù†ØªØ¸Ø§Ø± Ø§ÙƒØªÙ…Ø§Ù„ rollout Ù„Ù„Ù€ backend..."
    - kubectl rollout status deployment/backend -n default
    - echo "â³ Ø§Ù†ØªØ¸Ø§Ø± Ø§ÙƒØªÙ…Ø§Ù„ rollout Ù„Ù„Ù€ frontend..."
    - kubectl rollout status deployment/frontend -n default

    # Ø¹Ø±Ø¶ Ù…Ù„Ø®Øµ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
    - echo "âœ… Ø­Ø§Ù„Ø© Ø§Ù„Ù€ Pods Ø¨Ø¹Ø¯ Ø§Ù„Ù†Ø´Ø±:"
    - kubectl get pods -n default
  only:
    - main
  when: manual   # Ù„Ù„ØªÙ†ÙÙŠØ° Ø§Ù„ÙŠØ¯ÙˆÙŠ Ø¨Ø¹Ø¯ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©
