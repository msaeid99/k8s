stages:
  - build
  - test
  - push
  - deploy

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"
  BACKEND_IMAGE: $CI_REGISTRY_IMAGE/backend:$CI_COMMIT_SHORT_SHA
  FRONTEND_IMAGE: $CI_REGISTRY_IMAGE/frontend:$CI_COMMIT_SHORT_SHA

# Stage 1: Build - Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù€ Docker Images
build_backend:
  stage: build
  image: docker:24.0.5
  services:
    - docker:24.0.5-dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - cd backend
    - docker build -t $BACKEND_IMAGE .
    - docker push $BACKEND_IMAGE
  only:
    - main
    - develop

build_frontend:
  stage: build
  image: docker:24.0.5
  services:
    - docker:24.0.5-dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - cd frontend
    - docker build -t $FRONTEND_IMAGE .
    - docker push $FRONTEND_IMAGE
  only:
    - main
    - develop

# Stage 2: Test - Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙƒÙˆØ¯
test_backend:
  stage: test
  image: python:3.11
  variables:
    PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  cache:
    key: pip-cache
    paths:
      - .cache/pip
  script:
    - echo "PWD:" && pwd
    - ls -la
    - test -f backend/requirements.txt || (echo "âŒ backend/requirements.txt missing!" && exit 42)
    - pip install --upgrade pip
    - pip install -r backend/requirements.txt
    # Ù„Ùˆ Ø¹Ù†Ø¯Ùƒ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª pytest Ø´ØºÙ‘Ù„Ù‡Ø§ØŒ Ù„Ùˆ Ù„Ø£ Ù‡Ù†Ø¹Ø¯Ù‘ÙŠ
    - pip install pytest || true
    - pytest -q || echo "No pytest tests found, skipping"
  only:
    - main
    - develop

test_frontend:
  stage: test
  image: node:18
  script:
    - cd frontend
    - npm install
    - npm run test || echo "No tests found"
  only:
    - main
    - develop

# Stage 3: Push - Ø±ÙØ¹ Ø§Ù„Ù€ Images Ù„Ù„Ù€ Registry
push_images:
  stage: push
  image: docker:24.0.5
  services:
    - docker:24.0.5-dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    # Tag as latest
    - docker pull $BACKEND_IMAGE
    - docker tag $BACKEND_IMAGE $CI_REGISTRY_IMAGE/backend:latest
    - docker push $CI_REGISTRY_IMAGE/backend:latest
    
    - docker pull $FRONTEND_IMAGE
    - docker tag $FRONTEND_IMAGE $CI_REGISTRY_IMAGE/frontend:latest
    - docker push $CI_REGISTRY_IMAGE/frontend:latest
  only:
    - main

# ===== Stage 4: Deploy - Ù†Ø´Ø± Ø¹Ù„Ù‰ Kubernetes =====
deploy_to_k8s:
  stage: deploy
  tags:
    - minikube-local
  image:
    name: bitnami/kubectl:latest
    entrypoint: [""]
  only:
    - main
  when: manual
  script:
  - |
    set -euo pipefail
    export KUBECONFIG=/home/gitlab-runner/.kube/config
    NS=default

    echo "ğŸ” Checking Kubernetes cluster..."
    kubectl get nodes

    echo "ğŸš€ Deploying backend..."
    kubectl -n "$NS" set image deployment/backend  backend="$BACKEND_IMAGE"

    echo "ğŸš€ Deploying frontend..."
    kubectl -n "$NS" set image deployment/frontend frontend="$FRONTEND_IMAGE"

    echo "â³ Waiting for rollout..."
    kubectl -n "$NS" rollout status deployment/backend  --timeout=5m
    kubectl -n "$NS" rollout status deployment/frontend --timeout=5m

    echo "âœ… Deployment completed!"
    kubectl -n "$NS" get pods -o wide   # â† ØªØ£ÙƒØ¯ Ø¥Ù† Ø¯ÙŠ kubectl Ù…Ø´ kubec
    echo "ğŸ‰ Done."
