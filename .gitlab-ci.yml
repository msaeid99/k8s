stages:
  - build
  - test
  - push
  - deploy

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"
  BACKEND_IMAGE: $CI_REGISTRY_IMAGE/backend:$CI_COMMIT_SHORT_SHA
  FRONTEND_IMAGE: $CI_REGISTRY_IMAGE/frontend:$CI_COMMIT_SHORT_SHA

# Stage 1: Build - Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù€ Docker Images
build_backend:
  stage: build
  image: docker:24.0.5
  services:
    - docker:24.0.5-dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - cd backend
    - docker build -t $BACKEND_IMAGE .
    - docker push $BACKEND_IMAGE
  only:
    - main
    - develop

build_frontend:
  stage: build
  image: docker:24.0.5
  services:
    - docker:24.0.5-dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - cd frontend
    - docker build -t $FRONTEND_IMAGE .
    - docker push $FRONTEND_IMAGE
  only:
    - main
    - develop

# Stage 2: Test - Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙƒÙˆØ¯
test_backend:
  stage: test
  image: python:3.11
  variables:
    PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  cache:
    key: pip-cache
    paths:
      - .cache/pip
  script:
    - echo "PWD:" && pwd
    - ls -la
    - test -f backend/requirements.txt || (echo "âŒ backend/requirements.txt missing!" && exit 42)
    - pip install --upgrade pip
    - pip install -r backend/requirements.txt
    # Ù„Ùˆ Ø¹Ù†Ø¯Ùƒ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª pytest Ø´ØºÙ‘Ù„Ù‡Ø§ØŒ Ù„Ùˆ Ù„Ø£ Ù‡Ù†Ø¹Ø¯Ù‘ÙŠ
    - pip install pytest || true
    - pytest -q || echo "No pytest tests found, skipping"
  only:
    - main
    - develop

test_frontend:
  stage: test
  image: node:18
  script:
    - cd frontend
    - npm install
    - npm run test || echo "No tests found"
  only:
    - main
    - develop

# Stage 3: Push - Ø±ÙØ¹ Ø§Ù„Ù€ Images Ù„Ù„Ù€ Registry
push_images:
  stage: push
  image: docker:24.0.5
  services:
    - docker:24.0.5-dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    # Tag as latest
    - docker pull $BACKEND_IMAGE
    - docker tag $BACKEND_IMAGE $CI_REGISTRY_IMAGE/backend:latest
    - docker push $CI_REGISTRY_IMAGE/backend:latest
    
    - docker pull $FRONTEND_IMAGE
    - docker tag $FRONTEND_IMAGE $CI_REGISTRY_IMAGE/frontend:latest
    - docker push $CI_REGISTRY_IMAGE/frontend:latest
  only:
    - main

# ===== Stage 4: Deploy - Ù†Ø´Ø± Ø¹Ù„Ù‰ Kubernetes =====
deploy_to_k8s:
  stage: deploy
  tags:
    - minikube-local         # Ù„Ùˆ Ø¯Ù‡ Runner Ù…Ø­Ù„ÙŠ Ù„ÙƒÙ† Ø§Ù„ÙƒÙ„Ø§Ø³ØªØ± Ø­Ù‚ÙŠÙ‚ÙŠØŒ Ù…ÙÙŠØ´ Ù…Ø´ÙƒÙ„Ø©
  image:
    name: bitnami/kubectl:1.30   # Ø«Ø¨Ù‘Øª Ø§Ù„Ù†Ø³Ø®Ø© Ù„ØªÙØ§Ø¯ÙŠ ØªØºÙŠÙ‘Ø±Ø§Øª breaking
    entrypoint: [""]
  only:
    - main
  when: manual
  variables:
    KUBE_NAMESPACE: "default"
    ROLLOUT_TIMEOUT: "300s"
  script:
    - |
      set -euo pipefail

      # Ø§ÙƒØªØ¨ kubeconfig Ù…Ù† Ø³ÙŠÙƒØ±Øª (Ø£ÙØ¶Ù„ Ù…Ù† Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ Ø¹Ù„Ù‰ Ù…Ø³Ø§Ø± Ù…Ø­Ù„ÙŠ)
      # Ø®Ø²Ù‘Ù† kubeconfig ÙƒÙ€ Base64 ÙÙŠ Ù…ØªØºÙŠØ± GitLab Ø§Ø³Ù…Ù‡ KUBECONFIG_DATA
      if [ -n "${KUBECONFIG_DATA:-}" ]; then
        echo "$KUBECONFIG_DATA" | base64 -d > kubeconfig
        export KUBECONFIG="$PWD/kubeconfig"
      else
        # fallback Ù„Ùˆ Ø§Ù†Øª Ù…ØµØ± ØªØ³ØªØ®Ø¯Ù… Ù…Ù„Ù Ù…Ø­Ù„ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ±
        export KUBECONFIG=${KUBECONFIG:-/home/gitlab-runner/.kube/config}
      fi

      NS="${KUBE_NAMESPACE}"

      # Ø¯Ø¨Ø§Ú¯ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù†Ø¯ Ø£ÙŠ ERR
      failure_debug() {
        echo "------ DEBUG (namespace: $NS) ------"
        kubectl -n "$NS" get all || true
        echo "------ Events (last 100) ------"
        kubectl -n "$NS" get events --sort-by=.lastTimestamp | tail -n 100 || true
        for dep in backend frontend; do
          kubectl -n "$NS" get deploy "$dep" >/dev/null 2>&1 && kubectl -n "$NS" describe deploy "$dep" || true
          pods=$(kubectl -n "$NS" get pods -l app="$dep" -o name 2>/dev/null || true)
          for p in $pods; do
            echo "---- logs $p ----"
            kubectl -n "$NS" logs "$p" --all-containers=true --tail=200 || true
          done
        done
      }
      trap 'failure_debug' ERR

      echo "ðŸ” Checking Kubernetes cluster..."
      kubectl version --short
      kubectl cluster-info
      kubectl get nodes -o wide

      # Ø§ØªØ£ÙƒØ¯ Ø¥Ù† Ø§Ù„Ù€ Namespace Ù…ÙˆØ¬ÙˆØ¯
      kubectl get ns "$NS" >/dev/null 2>&1 || kubectl create ns "$NS"

      echo "ðŸš€ Deploying images..."
      # ØºÙŠÙ‘Ø± Ø§Ù„ØµÙˆØ± Ù„Ùˆ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ù…ØªØ¹Ø±ÙØ©
      if [ -n "${BACKEND_IMAGE:-}" ] && kubectl -n "$NS" get deploy backend >/dev/null 2>&1; then
        kubectl -n "$NS" set image deployment/backend backend="$BACKEND_IMAGE"
      else
        echo "â„¹ï¸ BACKEND_IMAGE not set or deployment/backend not found â€” skipping"
      fi

      if [ -n "${FRONTEND_IMAGE:-}" ] && kubectl -n "$NS" get deploy frontend >/dev/null 2>&1; then
        kubectl -n "$NS" set image deployment/frontend frontend="$FRONTEND_IMAGE"
      else
        echo "â„¹ï¸ FRONTEND_IMAGE not set or deployment/frontend not found â€” skipping"
      fi

      echo "â³ Waiting for rollout..."
      kubectl -n "$NS" get deploy backend   >/dev/null 2>&1 && kubectl -n "$NS" rollout status deploy/backend   --timeout="$ROLLOUT_TIMEOUT" || true
      kubectl -n "$NS" get deploy frontend  >/dev/null 2>&1 && kubectl -n "$NS" rollout status deploy/frontend  --timeout="$ROLLOUT_TIMEOUT" || true

      echo "âœ… Deployment completed!"
      kubectl -n "$NS" get deploy,svc,ingress -o wide
      kubectl -n "$NS" get pods -o wide
      echo "ðŸŽ‰ Done."
