stages:
  - build
  - test
  - push
  - deploy

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"
  BACKEND_IMAGE: $CI_REGISTRY_IMAGE/backend:$CI_COMMIT_SHORT_SHA
  FRONTEND_IMAGE: $CI_REGISTRY_IMAGE/frontend:$CI_COMMIT_SHORT_SHA

# Stage 1: Build - Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù€ Docker Images
build_backend:
  stage: build
  image: docker:24.0.5
  services:
    - docker:24.0.5-dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - cd backend
    - docker build -t $BACKEND_IMAGE .
    - docker push $BACKEND_IMAGE
  only:
    - main
    - develop

build_frontend:
  stage: build
  image: docker:24.0.5
  services:
    - docker:24.0.5-dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - cd frontend
    - docker build -t $FRONTEND_IMAGE .
    - docker push $FRONTEND_IMAGE
  only:
    - main
    - develop

# Stage 2: Test - Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙƒÙˆØ¯
test_backend:
  stage: test
  image: python:3.11
  variables:
    PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  cache:
    key: pip-cache
    paths:
      - .cache/pip
  script:
    - echo "PWD:" && pwd
    - ls -la
    - test -f backend/requirements.txt || (echo "âŒ backend/requirements.txt missing!" && exit 42)
    - pip install --upgrade pip
    - pip install -r backend/requirements.txt
    # Ù„Ùˆ Ø¹Ù†Ø¯Ùƒ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª pytest Ø´ØºÙ‘Ù„Ù‡Ø§ØŒ Ù„Ùˆ Ù„Ø£ Ù‡Ù†Ø¹Ø¯Ù‘ÙŠ
    - pip install pytest || true
    - pytest -q || echo "No pytest tests found, skipping"
  only:
    - main
    - develop

test_frontend:
  stage: test
  image: node:18
  script:
    - cd frontend
    - npm install
    - npm run test || echo "No tests found"
  only:
    - main
    - develop

# Stage 3: Push - Ø±ÙØ¹ Ø§Ù„Ù€ Images Ù„Ù„Ù€ Registry
push_images:
  stage: push
  image: docker:24.0.5
  services:
    - docker:24.0.5-dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    # Tag as latest
    - docker pull $BACKEND_IMAGE
    - docker tag $BACKEND_IMAGE $CI_REGISTRY_IMAGE/backend:latest
    - docker push $CI_REGISTRY_IMAGE/backend:latest
    
    - docker pull $FRONTEND_IMAGE
    - docker tag $FRONTEND_IMAGE $CI_REGISTRY_IMAGE/frontend:latest
    - docker push $CI_REGISTRY_IMAGE/frontend:latest
  only:
    - main

# ===== Stage 4: Deploy - Ù†Ø´Ø± Ø¹Ù„Ù‰ Kubernetes =====
deploy_to_k8s:
  stage: deploy
  image:
    name: bitnami/kubectl:latest
    entrypoint: [""]
  only: 
    - main
  when: manual
  script:
    - |
      set -eo pipefail
      
      # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù kubeconfig Ù…Ù† Ø§Ù„Ù…ØªØºÙŠØ±
      mkdir -p ~/.kube
      echo "$KUBECONFIG_FILE" > ~/.kube/config
      chmod 600 ~/.kube/config
      
      # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù€ cluster
      echo "ğŸ” Checking cluster connection..."
      kubectl config use-context minikube
      kubectl get nodes
      
      # ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù€ backend deployment
      echo "ğŸš€ Updating backend deployment..."
      kubectl set image deployment/backend backend="$BACKEND_IMAGE" -n default
      
      # ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù€ frontend deployment
      echo "ğŸš€ Updating frontend deployment..."
      kubectl set image deployment/frontend frontend="$FRONTEND_IMAGE" -n default
      
      # Ù…ØªØ§Ø¨Ø¹Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ù€ rollout Ù„Ù„Ù€ backend
      echo "â³ Waiting for backend rollout..."
      kubectl rollout status deployment/backend -n default --timeout=5m
      
      # Ù…ØªØ§Ø¨Ø¹Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ù€ rollout Ù„Ù„Ù€ frontend
      echo "â³ Waiting for frontend rollout..."
      kubectl rollout status deployment/frontend -n default --timeout=5m
      
      # Ø¹Ø±Ø¶ Ø­Ø§Ù„Ø© Ø§Ù„Ù€ pods
      echo "âœ… Deployment completed! Current pods:"
      kubectl get pods -n default -o wide
  
  # Ø¥Ø¶Ø§ÙØ© retry ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„ÙØ´Ù„
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure